/*
 * Copyright (c) 2023 Dmitry Romanchenko.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

// Память комманд (диодная матрица)
// Организация памяти: 64 строки по 38 столбцов
// Память содержит 128 команд и делится на 2 области - младшую (адреса с 0 по 63) и старшую (адреса с 64 по 127)
// Наличие диода - '+', отсутствие диода - '-'
// Строка состоит из 19 блоков по 2 диода. Каждый блок кодирует 1 бит команды. 
// Первый диод в блоке кодирует младшую область команд, втрой старшую.

// Организация строки:
// |М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С| - область команд (младшая, старшая)
// |- +|+ +|- +|- +|+ +|+ -|- +|- +|+ +|- +|- +|+ +|- +|+ +|+ +|+ +|+ -|- +|- +| - строка
// | 4 | 3 | 2 | 1 | 0 |   | 0 | 1 | 2 | 0 | 1 | 2 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | - номер бита в поле команды
// |-------------------|   |-----------|-----------|---------------------------| 
// |        АСП        |МОД|    КОМ    |    КУС    |            АП             | - поля команды
// Поля команды:
// АСП - адрес синхропрограммы (5 бит - адресует 32 синхропрограммы)
// МОД - модификатор команды (1 бит, разрешает/запрещает запись в регистр R и отображение на дисплее)
// КОМ - регистр режима выполнения синхропрограммы (3 бита - 8 режимов)
// КУС - регистр ветвления (3 бита, определяет режим вычисления адреса следующей команды)
// АП  - адрес программного перехода (6 бит, используется при вычислении адреса следующей команды)

const COMMANDS = 
    "-+++-+-++++--+-+++-+-+++-++++++++--+-+"+
    "--++++--++++--+--+---+++++-++-++-+-+++"+
    "++---++++++++-++----+-+++--+--++++++--"+
    "++--+++--+++-+--++---+++---+--+-+++---"+
    "++++-+++++++-+-++-----+++-++-++--+++--"+
    "+-++------++-+++------+++--+-++--+++++"+
    "+---++----++-+--++----++----+--+-+----"+
    "-++++------++-+--++--++++---+-+--+----"+
    "---+--+++++------+++--++--++-+-+-+-+--"+
    "+--++++-+-++----+-+---+++++-+++-++-+--"+
    "+--+---++-+----++----+++++-+---+--+-++"+
    "---+--+---++--+-----+--++-+-++-++++++-"+
    "++++---+--++----+-----+++++--++---+-++"+
    "++++--+-++++---++-----++++++----+-++++"+
    "+----+--+-+++--++-----+++--++-+-++++--"+
    "-+++--+---++----+++--++++-+++--+----++"+
    "+++++++-++++----+-+----++++++-++++++-+"+
    "-++-++--+-++-+-+------+++---+-+-++----"+
    "++--+--++++++---+++---++----++--------"+
    "+--+++---++---+------++--++++++----+--"+
    "-+-++-++++++-----+---++-+---++-+++---+"+
    "++----+---++----+-----++----++++-++---"+
    "-+-++---+++++-++----+-++---+----++--+-"+
    "+--++-+-+-+--+++-----+++++-+++-+-++-+-"+
    "++----+--+++--++--++---+++----+---+-++"+
    "++++--++--++-------+--+-++++++-+++--+-"+
    "+--+++----++----+------+++++--+-+---++"+
    "+++++++++-+++-+-+--+-----+++++--++-++-"+
    "+--+++-++-+++-+--+---+++++----+++---++"+
    "+-++++---++++-+-----+--+++--+-+--+-+++"+
    "++-+-+++++++--++--++----++----++----++"+
    "--++-+-+++++---+---+--++---+-+-------+"+
    "++---+-+--++-----+-++-+-----++-+++-+++"+
    "---+++++++++--+--++---++-+---+-+--++++"+
    "+++-++----++-++--+++---+--++--+-++-+--"+
    "-+---+----++-+---++--+++--++--+-+++++-"+
    "+++---+-++++--++---+--++++-++-++-++---"+
    "+++++++--+++--+---++--+-++--+-++++++-+"+
    "+-+++----++++---++-+--+--+--+--+---+--"+
    "-------+++-+-+-++--++-++++--++------++"+
    "+++--++-+-++--++----+--++-+++------+++"+
    "+--+--+-++++--+--+--+--+-++++++---++++"+
    "---++-++---++-+---+---++--+-+---++----"+
    "+++---+--+-+----++--+++---+++++---+---"+
    "-+++--+--+++-+--++---++-+--+++++-+-+-+"+
    "-++--+-++-++---++-+----+++-++++++++-+-"+
    "-+--+-+++++---+----+--++++-+-++++++---"+
    "++++++++++-+-----++-+---+++++-+--++-++"+
    "--+-+++--++---+--+---+++--+++-+++--+-+"+
    "+-+---+--+++--------+--++-+++--+-++--+"+
    "-+--++---++++--++----++++------+++--+-"+
    "+++++--++-++----------++-+--++--+-+--+"+
    "---+-++--+++----+-+---+++----+-+-++-++"+
    "++++-+----++--+---+---++---++---+---++"+
    "+--+-++--+++---++-----++-+++-+-+++----"+
    "+++-+-+--+++-+++--++---+++-++---+-----"+
    "+-+-++---+++-+++---+--++-++-+++++++-++"+
    "--++--++++++----------+++-+--+++++-+++"+
    "+-+--+--++++-+++---++--+++++++-+++--++"+
    "---+++--+-++---++-+---+++--+----++-++-"+
    "+-++--+--++--+++----++-++-++--+++-+-++"+
    "++--+--++-+++---++++--+-++++-++-++-+-+"+
    "----+++--+++-----+---+++-+-+-+-+--+-++"+
    "+-+-+-+++++-+-+-+-+--+-++---+---++++--";

// Память синхропрограмм (диодная матрица)
// Наличие диода - '+', отсутствие диода - '-'
// Организация памяти: 96 строк по 30 столбцов
// Память содержит 32 синхропрограммы. Синхропрограмма состоит из 6 групп по 3 адреса микрокоманд.
// Группа определяет какие микрокоманды выполняются в течение сигнала Дi. Соответствие между номером группы (6 групп) и индексом i (от 1 до 12)
// определяется полем КОМ из текущей команды. 3 адреса в группе определяют микрокоманды выполняемые в течение сигналов Е1, Е2 и Е3 соответственно.

// Организация строки:
// |+ - - - - -|+ - + - + -|- - - - - +|+ - + - - -|- - - - + +| - строка
// |4 1 6 3 5 2|2 5 3 6 1 4|2 5 3 6 1 4|2 5 3 6 1 4|2 5 3 6 1 4| - номер группы, к которой относится адрес микрокоманды
// |     4           3           2           1           0     | - индекс бита адреса микрокоманды

const SPROGS = 
    "+-----+-+-+------++-+-------++"+
    "-+----+-+-++------+-+--+------"+
    "-----++-----+-+-++--+---+---+-"+
    "------+-+-+-------+---+---+---"+
    "-----------------+---------+-+"+
    "-------+-+-+--+-----------+---"+
    "-------+-+--------------------"+
    "--------+--+--+-+-----+----++-"+
    "-+-----+-++---+-------+---+-+-"+
    "---+---+++--------+-+-----+---"+
    "--+------+------++----++---+++"+
    "-------+-+--+-----+-----+-----"+
    "-++----------++-+--++----+++++"+
    "-++++++++++-------------+++++-"+
    "-------+-+------+-----+-----+-"+
    "------+-+-+-+-+-+-+-+-+-+-+-+-"+
    "-------------++--+-+------++-+"+
    "++-+-++-+-++------------+-+-++"+
    "----------------++----+-----+-"+
    "-----------+-+-+++-+-++----++-"+
    "---+----+------+----+-----++--"+
    "-------------+-----+----------"+
    "+---+-+++-+--+---+-------+---+"+
    "-+-----+-+------+-----------+-"+
    "------++++++------------------"+
    "------+-+-++-----+------------"+
    "--+--------+--+--+---------+--"+
    "------+++++-++++++++++++++++++"+
    "-+-+++-----------+------+++-++"+
    "-+--+--+--+--+-+------+--+--+-"+
    "----------------------------+-"+
    "-------+-+----+-++--+--+----++"+
    "---+---+-+--+-+-++--++---++---"+
    "-+--------+--+--------------+-"+
    "------+-+---+++------++--+----"+
    "------------------------------"+
    "-+++++------------------+++++-"+
    "-+----++---++-+--+++-----+----"+
    "-+--+-+++++-------+-++--------"+
    "------++++++------++++------++"+
    "-------+-+----+-+----++--+--+-"+
    "------+-+-++------+-+--+-+--++"+
    "+-+---+-+++++-+-+++-+++-+-++++"+
    "---+-++-+---+-----------+-----"+
    "-+---------+--++++---+-----++-"+
    "---+-++-+--++-+--++-------+-++"+
    "-------------+----------------"+
    "--+-----++-----+----------++--"+
    "+----------+------------------"+
    "----++++-+--+-----+--+--------"+
    "++++++-----+-----+------++++++"+
    "-++++++++++------++++++-------"+
    "---++-+++++-+-+-+-+-+++-------"+
    "-----------------+-----+---++-"+
    "----+-++-++-+---+-+--++-------"+
    "-+-+-+++-+----+-----++--+++-+-"+
    "--------+----++-------+-------"+
    "-+-+-++++++----------+--+++-+-"+
    "+-+-+-+++++--+-+-------+-----+"+
    "----+--+---+----+--+-----+---+"+
    "------------+-+-+++---++--+--+"+
    "+----------+----------+-------"+
    "-+-+-+------+-+-++-----------+"+
    "-+-+-+------+-+-+++-+-++------"+
    "---++--+-----+-+++--+--+-+-+++"+
    "+--++++++--++++--++++--++++--+"+
    "----------------+----------++-"+
    "----+-++++++-+----+-++++++++++"+
    "-------+---------+-----+-+----"+
    "----+--------------------+----"+
    "-++-++------+++++---------+---"+
    "-+---+------+++++-+++++-------"+
    "--+++--------++++--++++---+-+-"+
    "-+-+-+------+++-+++++-+--+---+"+
    "-+++-+---+--------------+-+-++"+
    "+---+--+-----++-----+--++----+"+
    "--+-----------+++---+-+---++--"+
    "-+---+--------------------+---"+
    "-------+-----+-----------+----"+
    "--+-+--------+++---+-----+++--"+
    "++-+++------------------+++-++"+
    "+-+-+------+++-+--+----++----+"+
    "------------+----++----++-----"+
    "--------------+-++-++-++--+--+"+
    "-------------+-++--+-++-----+-"+
    "+-+-++++-+-+--+---+--+-++--+-+"+
    "-------------+++---+++--+-+---"+
    "-------------+++----+----+-+--"+
    "---+---------+-----+---+--+-++"+
    "-------------+-+---------+-++-"+
    "-+-+-++-+---+-+-------+-----+-"+
    "----------+--+--++----------++"+
    "------+-+--------+------------"+
    "----------------++-----+----++"+
    "------+-+--+-+----------------"+
    "------+++--+-------------+----";

// Память микрокоманд (диодная матрица)
// Наличие диода - '+', отсутствие диода - '-'
// Организация памяти: 32 строки по 18 столбцов
// Микрокоманда определяет набор микроприказов  
const UCMDS = 
    "+-------+----++-++"+
    "+------------+--++"+
    "--------+-+--+--++"+
    "------+-+----+--++"+
    "++------+----++-++"+
    "+------++----+--++"+
    "+-----+------+--++"+
    "----+---+----+--++"+
    "++------++---+--++"+
    "--------+--+-+--++"+
    "---+----+--+-+--++"+
    "++--------+-----++"+
    "+-------+--+-+-+++"+
    "----+------+-+--++"+
    "+-------+----++++-"+
    "++---------+-+-+-+"+
    "+----------+-+-++-"+
    "+----------+-+--++"+
    "------+------+-+-+"+
    "----+-------++--++"+
    "+-----------++--++"+
    "+------+-----+--++"+
    "+-----+----+-+--++"+
    "--------+---++--++"+
    "----+---+--+-+--++"+
    "+----------+-+-+-+"+
    "++---------+-++-++"+
    "++-----------++-++"+
    "---+--------++--++"+
    "+----------+--+-++"+
    "---+---++--+-++-++"+
    "--+-----+----+--++";

MNEMONICS = [
    [ "",                       "" ],
    [ "S = 0",                  "S = 0" ],
    [ "L S = S + M00",          "L S = S + M00" ],
    [ "L S = S + 6",            "L S = S + 6" ],
    [ "R-1 = S",                "" ],
    [ "S = 0xF",                "S = 0xF" ],
    [ "S = 6",                  "S = 6" ],
    [ "L S = S + 1",            "L S = S + 1" ],
    [ "R-1 = S = S + L?0:10",   "S = S + L?0:10" ],
    [ "L S = R00 + S",          "L S = R00 + S" ],
    [ "L S = R00 + S + L?1:0",  "L S = R00 + S + L?1:0" ],
    [ "R-1 = S = M00; M00 = S", "S <=> M00" ],
    [ "S = R00 + S; R00 = 0",   "S = R00 + S" ],
    [ "L S = R00 + 1",          "L S = R00 + 1" ],
    [ "R00 = R33",              "" ],
    [ "R-1 = S = R00; R00 = S", "S = R00" ],
    [ "S = R00; R00 = R33",     "S = R00" ],
    [ "S = R00",                "S = R00" ],
    [ "L = 0; S = 6; R00 = S",  "L = 0; S = 6" ],
    [ "L S = ~R00 + 1",         "L S = ~R00 + 1" ],
    [ "S = ~R00",               "S = ~R00" ],
    [ "S = ~S",                 "S = ~S" ],
    [ "S = R00 + 6",            "S = R00 + 6" ],
    [ "L S = ~R00 + S",         "L S = ~R00 + S" ],
    [ "L S = R00 + S + 1",      "L S = R00 + S + 1" ],
    [ "S <=> R00",              "S = R00" ],
    [ "R-1 = R00",              "" ],
    [ "R-1 = 0",                "" ],
    [ "L S = ~R00 + L?1:0",     "L S = ~R00 + L?1:0" ],
    [ "M00 = S",                "M00 = S" ],
    [ "L = R00 - L?0:1",        "L = R00 - L?0:1" ],
    [ "L S = S + T?0:1",        "L S = S + T?0:1" ]
];


