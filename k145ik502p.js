/*
 * Copyright (c) 2023-2025 Dmitry Romanchenko.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, version 3.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */

// Этот файл содержит дампы ПЗУ БИС К145ИК502П.
// Данная БИС применялись в советском калькуляторе "Электроника Б3-21".
// Дампы созданы на основе анализа фотографий кристалла этой БИС,
// опубликованных на сайте "Радиокартинки" https://radiopicture.listbb.ru 

// Память комманд (диодная матрица)
// Организация памяти: 64 строки по 38 столбцов
// Память содержит 128 команд и делится на 2 области - младшую (адреса с 0 по 63) и старшую (адреса с 64 по 127)
// Наличие диода - '+', отсутствие диода - '-'
// Строка состоит из 19 блоков по 2 диода. Каждый блок кодирует 1 бит команды. 
// Первый диод в блоке кодирует младшую область команд, втрой старшую.

// Организация строки:
// |М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С|М С| - область команд (младшая, старшая)
// |- +|+ +|- +|- +|+ +|+ -|- +|- +|+ +|- +|- +|+ +|- +|+ +|+ +|+ +|+ -|- +|- +| - строка
// | 4 | 3 | 2 | 1 | 0 |   | 0 | 1 | 2 | 0 | 1 | 2 | 0 | 1 | 2 | 3 | 4 | 5 | 6 | - номер бита в поле команды
// |-------------------|   |-----------|-----------|---------------------------| 
// |        АСП        |МОД|    КОМ    |    КУС    |            АП             | - поля команды
// Поля команды:
// АСП - адрес синхропрограммы (5 бит - адресует 32 синхропрограммы)
// МОД - модификатор команды (1 бит, разрешает/запрещает запись в регистр R и отображение на дисплее)
// КОМ - регистр режима выполнения синхропрограммы (3 бита - 8 режимов)
// КУС - регистр ветвления (3 бита, определяет режим вычисления адреса следующей команды)
// АП  - адрес программного перехода (6 бит, используется при вычислении адреса следующей команды)

const COMMANDS_IK502P = 
    "++----+-++++-----+---++-++++++--+-+++-"+
    "---++-++++++++++--+--+-+--+--++-+----+"+
    "--------++++----++----++++---+--+++---"+
    "--+--+--+-++---++---+++++-+-++++++--+-"+
    "-+-+--++-++++---+---+++---+++-+-++-+++"+
    "--+-+++---++--++-----++++--+---+-++-+-"+
    "-+++++--+-++--+-----+--+--++---++--+--"+
    "+++-+--+--++-----+-+--+----+++-++-++--"+
    "---++++--+++----+----+++++-+-++--++---"+
    "+-+--+-++-++++++--+---++-++++-+-+--+-+"+
    "--------++++----++----++++---+-+++-++-"+
    "-+---------++-+-+-+++----+-+-+-+-+--++"+
    "------+-+-++++++-+--+++-+++-++-+++-++-"+
    "++--+--+--+++-+--++---++--++--+-+++--+"+
    "--------++++----+++----+++---++++++-+-"+
    "---++++-+-++---++------+--+-++++++++--"+
    "++--+--+---+---++---+-++--+++---+++--+"+
    "----+--++-++---++---++-+-+----+-+-+-+-"+
    "-+-++-----++-+-++--++-+++-++-+++-+++++"+
    "--+--+++--++-+++------++--+++-+---++--"+
    "-----+---+++----++----++-----+-----+-+"+
    "--+-++----++--++-----+++--+++-+++---+-"+
    "-+---+----+++-+-+++-+-++----++-+-+-++-"+
    "--+---+++-++++--++---++++--+-+++---++-"+
    "-+-+-+++-+++--+-----++++---+-+++-+----"+
    "-++-++--+++++-+-------+++++-+-+---+--+"+
    "+--++-+--+++-+-+----++-+-++-++--+-----"+
    "--++---+--+++-++--+----+--++++++--+++-"+
    "-+---+++--++--+---+---++-+--+++------+"+
    "+--++++-+-++---+--+----+----++-+-+++--"+
    "+++--+--++++----+---+--+--++++--+---+-"+
    "-+----+-++++---++-+----++-++-++++++-++"+
    "--+--+---++++-+--+--+-+++-+--+++++-++-"+
    "-+-+-------++-+-+++++-+-++-++++++++-++"+
    "-++-------++----+-----+++++++-+-++-+++"+
    "++-+------++----++-+--+-+--+-----++++-"+
    "-+--+--++-++----++--+--+-+-+-++--++---"+
    "--+++-----++----+++---+++--++++----++-"+
    "------+-+-++-+-+++--+--+-+-+-++---++++"+
    "----++----+---++----++++++++++----+++-"+
    "-+----+--+++++-++++---++----+----+-++-"+
    "--+---++---++++-+++++-+++--+++-++-+-+-"+
    "--+++-+----++-+-+++-+-+++--+---++-+-+-"+
    "+----+-++-++----++--+--++-++-+++-++-+-"+
    "-++-----+++++-++----+-+++-+-+++-+--+++"+
    "--------+-++-+++-+---++-++++--++-+--++"+
    "-++-------++----++----+++-+++-++-++-+-"+
    "---+++-+-+++--+--+-++-+++-+++-++-++-+-"+
    "--+--++-+-++--++----++-++--------+-+--"+
    "---------+-+-----++-+--+++---+--+++-++"+
    "-+-+--+++-+++++++-+----+++++-++-+++-+-"+
    "+--+-----+++-+-+-----+++-+-++---++-+--"+
    "--++-+-+-+++++++--+--+++-++-+-+-+--+++"+
    "---------+-+-----++-+--+++--++-++++-++"+
    "---+--++--+++---+++--++-++++-+------+-"+
    "+--+--+-++++-+-+----++-+-+-++++-+++++-"+
    "-+-+-+++--++--+-----+-+--+-----+++--++"+
    "---+++--+-+++-+---------++--+--+-++-++"+
    "-++--++---++----++--+--++++-+-++---++-"+
    "-----++++-++-+-++--+--+-++++++-+-+--++"+
    "+-+-++-+++++---+---+--++--+--++-+----+"+
    "---------+-+-----++-+--++++-+++-+++++-"+
    "+-++-+++--++----++--++++----++++++-+--"+
    "----------+-++++++----+-++-+++++--+-++"

// Память синхропрограмм (диодная матрица)
// Наличие диода - '+', отсутствие диода - '-'
// Организация памяти: 96 строк по 30 столбцов
// Память содержит 32 синхропрограммы. Синхропрограмма состоит из 6 групп по 3 адреса микрокоманд.
// Группа определяет какие микрокоманды выполняются в течение сигнала Дi. Соответствие между номером группы (6 групп) и индексом i (от 1 до 12)
// определяется полем КОМ из текущей команды. 3 адреса в группе определяют микрокоманды выполняемые в течение сигналов Е1, Е2 и Е3 соответственно.

// Организация строки:
// |+ - - - - -|+ - + - + -|- - - - - +|+ - + - - -|- - - - + +| - строка
// |4 1 6 3 5 2|2 5 3 6 1 4|2 5 3 6 1 4|2 5 3 6 1 4|2 5 3 6 1 4| - номер группы, к которой относится адрес микрокоманды
// |     4           3           2           1           0     | - индекс бита адреса микрокоманды

const SPROGS_IK502P = 
    "+---+-----+-----------++-+----"+
    "-------+-+--------------------"+
    "------------------+--+-----+-+"+
    "+-----------+-----+-------+--+"+
    "------------+--++---------++--"+
    "+-----------------------------"+
    "---++--------+-----------++---"+
    "-------------------+-+--------"+
    "+----++------+--+-+------+---+"+
    "-+--+--------------+++----++--"+
    "---------------------++---+++-"+
    "+----+-------------------+----"+
    "-------+-----------+------+---"+
    "---++--------+----+-----+-----"+
    "------+----------++----++---+-"+
    "-------------+------+----++---"+
    "--+----------+---++-+-+-+-+++-"+
    "-+----+---------+-+------++---"+
    "---------------------+--------"+
    "------------------------------"+
    "----------+-----------+---+---"+
    "--+----+----------+--+-----+--"+
    "------------------------------"+
    "------------------------------"+
    "-+-----------+----+------+-+--"+
    "+--+--------+------+-+--+----+"+
    "------++++++------------++++++"+
    "--+---------------+-----------"+
    "---+--------+-+---+-+-----++--"+
    "------------------------------"+
    "------+------+-----------+----"+
    "-+---++-----+---+-------+---+-"+
    "-+-+-++-+-+---+----+----------"+
    "----+--+------+----+----------"+
    "------------++++++++++++++++++"+
    "--------------+----+---++-+---"+
    "--+---------+-----+-----------"+
    "------------++++++------------"+
    "---+--+-------+---+-----------"+
    "-+--+-------+++---++----------"+
    "------------------++++++++++++"+
    "------++++++------------++++++"+
    "-----+---------+--------+-----"+
    "+-----+++-+-+++-+------+------"+
    "-------+---+------+-+-+-------"+
    "-+----+++--++++--+----+-------"+
    "---------------------+--------"+
    "-------------------+-+--+-+-+-"+
    "----+---+----+-----------+----"+
    "-----+---------------+-------+"+
    "---+--+-+---------++----------"+
    "-------+-+-++-----------+-----"+
    "+----+-------------+-+--------"+
    "---+-----++----------++---+---"+
    "-+----------+-+----------+----"+
    "-------------+-+---------+-+--"+
    "------+++---+-++---+-++-+++---"+
    "-+-----------------++-+-+---+-"+
    "+-----------+-----------+-----"+
    "------------------+-+------+--"+
    "------------------------+-----"+
    "------------+-----+--+--------"+
    "------------------------------"+
    "---------------------------++-"+
    "-------+-----------+-----++---"+
    "------------------------------"+
    "------------------------------"+
    "+---+------------+--+--+-+----"+
    "--+------------+-+-----++-----"+
    "------------------------------"+
    "-----++------+-+--------------"+
    "----------------------------+-"+
    "-------+++------------------+-"+
    "------------++++++------------"+
    "---+----+-----+--+-----+------"+
    "--------------------+-------+-"+
    "----------+-----------+-------"+
    "----------------------------+-"+
    "+--+--++-++-++--+---++-+------"+
    "-------+-+--------------------"+
    "-------+-----+-----+-----++---"+
    "------+-++-----+---+-+-----+--"+
    "-------+-------++--+-++-++----"+
    "-----++-+------------+--------"+
    "--+-+---------------+---+----+"+
    "---------------------------++-"+
    "-+-----+----+---+-+-+---------"+
    "-----+--------++--++------++--"+
    "----+-----+--+--------+----+--"+
    "++------+------++---+------+--"+
    "-----++------+-----+---+-----+"+
    "--+-+-++++--+-+--+-------+++--"+
    "------------------------------"+
    "----+--------------+----+-----"+
    "------+-+--++-+--++-+-------+-"+
    "-----++-----------++-+--+-----"

// Память микрокоманд (диодная матрица)
// Наличие диода - '+', отсутствие диода - '-'
// Организация памяти: 32 строки по 18 столбцов
// Микрокоманда определяет набор микроприказов  
const UCMDS_IK502P = 
    "+------------++-++"+
    "+------------+--++"+
    "++------+----++-++"+
    "+----------+-+-+-+"+
    "+----------+-+--++"+
    "----+---+----+--++"+
    "-------+---+-+--++"+
    "++--------+--+--++"+
    "++-----------++-++"+
    "++--------+---+-++"+
    "+------+-----+--++"+
    "--------+--+-+-+-+"+
    "+------------++++-"+
    "++---------+-++-++"+
    "+-+-----+----+--++"+
    "---+---++--+-+--++"+
    "+---+---+----+--++"+
    "----+------+-+--++"+
    "--------+--+-+-++-"+
    "++--+---+----++-++"+
    "+-----+------+--++"+
    "----+--+-----+--++"+
    "+-------+---++-+-+"+
    "+--------+---+--++"+
    "+---------+--+--++"+
    "+----------+----++"+
    "--------+---++--++"+
    "+-------------+-++"+
    "--------++---+--++"+
    "---+---+-----+--++"+
    "++------++---++-++"+
    "----+--+---+-+--++"
    
SEGMENTS_IK502P = 
    "++++++++"+
    "-+++-++-"+
    "++-+++++"+
    "--++-+--"+
    "++++++++"+
    "--+--+-+"+
    "--+--+--"+
    "-++++++-"+
    "++++++++"+
    "--+----+"+
    "++++++-+"+
    "+-++----"+
    "++++++++"+
    "-++-++--"+
    "--+-----"+
    "--+---+-"

MNEMONICS_IK502P = [
    [ "", "" ],
    [ "S=0", "S=0" ],
    [ "R[-1]=S", "" ],
    [ "R[+0]<=>S", "S=R[+0]" ],
    [ "S=R[+0]", "S=R[+0]" ],
    [ "LS=S+1", "LS=S+1" ],
    [ "LS=~S+R[+0]", "LS=~S+R[+0]" ],
    [ "R[-1]=S=M[+0]", "S=M[+0]" ],
    [ "R[-1]=0", "" ],
    [ "R[-1]=M[+0];M[+0]=S", "M[+0]=S" ],
    [ "S=~S", "S=~S" ],
    [ "LS=R[+0]+1;R[+0]=S", "LS=R[+0]+1" ],
    [ "R[+0]=R[-3]", "" ],
    [ "R[-1]=R[+0]", "" ],
    [ "S=S+T?0:1", "S=S+T?0:1" ],
    [ "LS=R[-1]+L", "LS=R[-1]+L" ],
    [ "S=S+1", "S=S+1" ],
    [ "LS=R[+0]+1", "LS=R[+0]+1" ],
    [ "LS=S+R[+0];R[+0]=R[-3]", "LS=S+R[+0];R[+0]=R[-3]" ],
    [ "R[-1]=S+1", "" ],
    [ "S=6", "S=6" ],
    [ "LS=~S+1", "LS=~S+1" ],
    [ "S=~R[+0]+S;R[+0]=S", "S=~R[+0]+S;R[+0]=S" ],
    [ "S=L?0:10", "S=L?0:10" ],
    [ "S=M[+0]", "S=M[+0]" ],
    [ "S=R[+0];M[+0]=S", "S=R[+0];M[+0]=S" ],
    [ "LS=~R[+0]+S", "LS=~R[+0]+S" ],
    [ "M[+0]=S", "M[+0]=S" ],
    [ "LS=S+L?0:10", "LS=S+L?0:10" ],
    [ "LS=~S+L", "LS=~S+L" ],
    [ "R[-1]=S+L?0:10", "" ],
    [ "LS=R[+0]+~S+1", "LS=R[+0]+~S+1" ]
]

COMMENTS_IK502P = [
    "PC = 0x12", // 00
    "", // 01
    "", // 02
    "", // 03
    "", // 04
    "", // 05
    "", // 06
    "", // 07
    "", // 08
    "", // 09
    "", // 0A
    "", // 0B
    "", // 0C
    "", // 0D
    "", // 0E
    "", // 0F
    "", // 10
    "", // 11
    "Set data ring mark M0.M = 0x0fffffff0, PC = 0x34", // 12
    "", // 13
    "", // 14
    "", // 15
    "", // 16
    "", // 17
    "", // 18
    "", // 19
    "", // 1A
    "", // 1B
    "", // 1C
    "", // 1D
    "", // 1E
    "", // 1F
    "", // 20
    "", // 21
    "", // 22
    "", // 23
    "", // 24
    "", // 25
    "", // 26
    "", // 27
    "", // 28
    "", // 29
    "", // 2A
    "", // 2B
    "", // 2C
    "", // 2D
    "", // 2E
    "", // 2F
    "", // 30
    "", // 31
    "", // 32
    "", // 33
    "", // 34
    "", // 35
    "", // 36
    "", // 37
    "", // 38
    "", // 39
    "", // 3A
    "", // 3B
    "", // 3C
    "", // 3D
    "", // 3E
    "", // 3F
    "", // 40
    "", // 41
    "", // 42
    "", // 43
    "", // 44
    "", // 45
    "", // 46
    "", // 47
    "", // 48
    "", // 49
    "", // 4A
    "", // 4B
    "", // 4C
    "", // 4D
    "", // 4E
    "", // 4F
    "", // 50
    "", // 51
    "", // 52
    "", // 53
    "", // 54
    "", // 55
    "", // 56
    "", // 57
    "", // 58
    "", // 59
    "", // 5A
    "", // 5B
    "", // 5C
    "", // 5D
    "", // 5E
    "", // 5F
    "", // 60
    "", // 61
    "", // 62
    "", // 63
    "", // 64
    "", // 65
    "", // 66
    "", // 67
    "", // 68
    "", // 69
    "", // 6A
    "", // 6B
    "", // 6C
    "", // 0D
    "", // 6E
    "", // 6F
    "", // 70
    "", // 71
    "", // 72
    "", // 73
    "", // 74
    "", // 75
    "", // 76
    "", // 77
    "", // 78
    "", // 79
    "", // 7A
    "", // 7B
    "", // 7C
    "", // 7D
    "", // 7E
    "", // 7F
]

